<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Parallel RNGs - The Rust Rand Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Extended documentation for Rust&#x27;s Rand lib">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust Rand Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="parallel-rngs"><a class="header" href="#parallel-rngs">Parallel RNGs</a></h1>
<h2 id="theory-multiple-rngs"><a class="header" href="#theory-multiple-rngs">Theory: multiple RNGs</a></h2>
<p>If you want to use random generators in multiple worker threads simultaneously,
then you will want to use multiple RNGs. A few suggested approaches:</p>
<ol>
<li>Use <a href="https://docs.rs/rand/latest/rand/fn.rng.html"><code>rng()</code></a> in each worker thread. This is seeded automatically
(lazily and uniquely) on each thread where it is used.</li>
<li>Use <a href="https://docs.rs/rand/latest/rand/fn.rng.html"><code>rng()</code></a> (or another master RNG) to seed a custom RNG on each
worker thread. The main advantage here is flexibility over the RNG used.</li>
<li>Use a custom RNG per <em>work unit</em>, not per <em>worker thread</em>. If these RNGs
are seeded in a deterministic fashion, then deterministic results are
possible. Unfortunately, seeding a new RNG for each work unit from a master
generator cannot be done in parallel, thus may be slow.</li>
<li>Use a single master seed. For each work unit, seed an RNG using the master
seed and set the RNG's stream to the work unit number. This is potentially a
faster than (3) while still deterministic, but not supported by all RNGs.</li>
</ol>
<p>Note: do not simply clone RNGs for worker threads/units. Clones return the same
sequence of output as the original. You may however use clones if you then set
a unique stream on each.</p>
<h3 id="streams"><a class="header" href="#streams">Streams</a></h3>
<p>Which RNG families support multiple streams?</p>
<ul>
<li><a href="https://docs.rs/rand_chacha/latest/rand_chacha/">ChaCha</a>: the ChaCha RNGs
support 256-bit seed, 64-bit stream and 64-bit counter (per 16-word block),
thus supporting 2<sup>64</sup> streams of 2<sup>68</sup> words each.</li>
<li><a href="https://docs.rs/rand_hc/latest/rand_hc/">Hc128</a> is a cryptographic RNG
supporting a 256-bit seed; one could construct this seed from (e.g.) a
smaller 192-bit key plus a 64-bit stream.</li>
</ul>
<p>Note that the above approach of constructing the seed from a smaller key plus a
stream counter can only be recommended with cryptographic PRNGs since simpler
RNGs often have correlations in the RNG's output using two similar keys, and
may also require "random looking" seeds to produce high quality output.</p>
<p>Non-cryptographic PRNGs may still support multiple streams, but likely with
significant limitations (especially noting that a common recommendation with
such PRNGs is not to consume more than the square root of the generator's
period).</p>
<ul>
<li>
<p><a href="https://docs.rs/rand_xoshiro/latest/rand_xoshiro/">Xoshiro</a>: the Xoshiro
family of RNGs support <code>jump</code> and <code>long_jump</code> methods which may effectively
be used to divide the output of a single RNG into multiple streams. In
practice this is only useful with a small number of streams, since <code>jump</code>
must be called <code>n</code> times to select the nth "stream".</p>
</li>
<li>
<p><a href="https://docs.rs/rand_pcg/latest/rand_pcg/">Pcg</a>: these RNGs support
construction with <code>state</code> and <code>stream</code> parameters. Note, however, that the
RNGs have been critiqued in that multiple streams using the same key are
often strongly correlated. See the <a href="https://www.pcg-random.org/posts/critiquing-pcg-streams.html">author's own comments</a>.</p>
<p>The PCG RNGs <em>also</em> support an <code>fn advance(delta)</code> method, which might be
used to divide a single stream into multiple sub-streams as with Xoshiro's
<code>jump</code> (but better since the offset can be specified).</p>
</li>
</ul>
<h2 id="practice-non-deterministic-multi-threaded"><a class="header" href="#practice-non-deterministic-multi-threaded">Practice: non-deterministic multi-threaded</a></h2>
<p>We use Rayon's <a href="https://docs.rs/rayon/latest/rayon/iter/index.html">parallel iterators</a>, using <a href="https://docs.rs/rayon/latest/rayon/iter/trait.ParallelIterator.html#method.map_init"><code>map_init</code></a> to initialize an RNG in
each worker thread. Note: this RNG may be re-used across multiple work units,
which may be split between worker threads in non-deterministic fashion.</p>
<pre><pre class="playground"><code class="language-rust">use rand::distr::{Distribution, Uniform};
use rayon::prelude::*;

static SAMPLES: u64 = 1_000_000;

fn main() {
    let range = Uniform::new(-1.0f64, 1.0).unwrap();

    let in_circle = (0..SAMPLES)
        .into_par_iter()
        .map_init(|| rand::rng(), |rng, _| {
            let a = range.sample(rng);
            let b = range.sample(rng);
            if a * a + b * b &lt;= 1.0 {
                1
            } else {
                0
            }
        })
        .reduce(|| 0usize, |a, b| a + b);

    // prints something close to 3.14159...
    println!(
        "π is approximately {}",
        4. * (in_circle as f64) / (SAMPLES as f64)
    );
}</code></pre></pre>
<h2 id="practice-deterministic-multi-threaded"><a class="header" href="#practice-deterministic-multi-threaded">Practice: deterministic multi-threaded</a></h2>
<p>We use approach (4) above to achieve a deterministic result: initialize all RNGs
from a single seed, but using multiple streams.
We use <a href="https://docs.rs/rand_chacha/latest/rand_chacha/struct.ChaCha8Rng.html#method.set_stream"><code>ChaCha8Rng::set_stream</code></a> to achieve this.</p>
<p>Note further that we manually batch multiple work-units according to
<code>BATCH_SIZE</code>. This is important since the cost of initializing an RNG is large
compared to the cost of our work unit (generating two random samples plus some
trivial calculations). Manual batching could improve performance of the above
non-deterministic simulation too.</p>
<p>(Note: this example is <a href="https://github.com/rust-random/rand/blob/master/examples/rayon-monte-carlo.rs">https://github.com/rust-random/rand/blob/master/examples/rayon-monte-carlo.rs</a>.)</p>
<pre><pre class="playground"><code class="language-rust">use rand::distr::{Distribution, Uniform};
use rand_chacha::{rand_core::SeedableRng, ChaCha8Rng};
use rayon::prelude::*;

static SEED: u64 = 0;
static BATCH_SIZE: u64 = 10_000;
static BATCHES: u64 = 1000;

fn main() {
    let range = Uniform::new(-1.0f64, 1.0).unwrap();

    let in_circle = (0..BATCHES)
        .into_par_iter()
        .map(|i| {
            let mut rng = ChaCha8Rng::seed_from_u64(SEED);
            rng.set_stream(i);
            let mut count = 0;
            for _ in 0..BATCH_SIZE {
                let a = range.sample(&amp;mut rng);
                let b = range.sample(&amp;mut rng);
                if a * a + b * b &lt;= 1.0 {
                    count += 1;
                }
            }
            count
        })
        .reduce(|| 0usize, |a, b| a + b);

    // prints 3.1409052 (determinstic and reproducible result)
    println!(
        "π is approximately {}",
        4. * (in_circle as f64) / ((BATCH_SIZE * BATCHES) as f64)
    );
}</code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="guide-seeding.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="guide-values.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="guide-seeding.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="guide-values.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
